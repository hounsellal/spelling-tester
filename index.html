<!DOCTYPE html>
<html lang="en">
  <head>
    
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Spelling Tester</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.5.1/min/dropzone.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.5.1/min/basic.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
     <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  </head>
  <body class="plain">
    <div id="container" style="max-width:100vw;">


        <div class="container">

        <h1>Spelling Test</h1>
        
        <div class="form-group row storage-available test-inactive">
            <div class="col-xs-7 col-sm-10">
                <label for="existing-lists">Load List</label>
                <select class="form-control" id="existing-lists" onChange="loadList()">
                    <option value=""></option>
                </select>
            </div>
            <div class="col-xs-5 col-sm-2">
                <button class="btn btn-danger" style="margin-top:25px;" onClick="deleteList()">Delete</button>
            </div>
            
        </div>

        <div class="form-group test-inactive">
            <label for="list">Word List</label>
            <textarea rows="14" id="list" class="form-control" autocorrect="off" autocapitalize="none"></textarea>
        </div>

        <div class="form-group row">
            <div class="col-12 p-3 form-inline text-right" style="padding:15px;">
                <input class="form-control storage-available test-inactive" id="list-name" type="text" />
                <button class="btn btn-default storage-available test-inactive" onClick="saveList()">Save List</button>
            </div>
        </div>
        
        <div id="word-test" class="test-active">
            
        </div>

        <div class="form-group row">
            <div class="col-xs-6">
                <button class="btn btn-primary test-active" onClick="check();">Check</button>
            </div>
            <div class="col-xs-6 text-right">
                <button class="btn btn-success test-inactive" onClick="buildList()">Take Test</button>
                <button class="btn btn-danger test-active" onClick="finishTest()">End Test</button>
            </div>
        </div>
        
    </div>



    <script type="text/javascript">
        
        var savedLists = {};
        
        $( document ).ready(function() {
            $(".test-active").hide();
            if (typeof(Storage) !== "undefined") {
                // Code for localStorage/sessionStorage.
                var savedListJSON = localStorage.getItem("savedLists");
                if(savedListJSON) savedLists = JSON.parse(savedListJSON);
                for(let key in savedLists){
                $("#existing-lists").append(`<option value="${key}">${key}</option>`);
                }
            } else {
                // Sorry! No Web Storage support..
                $(".storage-available").hide();
            }
        });

        function saveList(){
            var wordList = $("#list").val();
            var listName = $("#list-name").val();
            if(!wordList || !listName) return;
            savedLists[listName] = wordList;
            localStorage.setItem("savedLists", JSON.stringify(savedLists));
            $("#existing-lists").append(`<option value="${listName}">${listName}</option>`);
            $("#existing-lists").val(listName);
        }
        
        function loadList(){
            var listName = $("#existing-lists").val();
            var list = savedLists[listName];
            $("#list").val(list);
            //buildList();
        }

        function deleteList(){
            var listName = $("#existing-lists").val();
            if(listName){
                delete savedLists[listName];
                localStorage.setItem("savedLists", JSON.stringify(savedLists));
                $("#existing-lists").find(`option[value='${listName}']`).remove();
                $("#existing-lists").val('');
                $("#list").val('');
            }
        }
        
        var synth = window.speechSynthesis;

        var inputForm = document.querySelector('form');
        var inputTxt = document.querySelector('.txt');
        var voiceSelect = document.querySelector('select');

        var pitch = document.querySelector('#pitch');
        var pitchValue = document.querySelector('.pitch-value');
        var rate = document.querySelector('#rate');
        var rateValue = document.querySelector('.rate-value');

        var voices = [];
        
        function buildList(){
            var wordList = $("#list").val();
            if(!wordList) {
                alert("Please add some words to your list");
                return;
            }
            $(".test-inactive").hide();
            $(".test-active").show();
            $("#word-test").html("");
            var words = wordList.split("\n");
            var counter = 1;
            words.forEach(function(word){
                word = word.trim();
                var newElement = `
                    <div class="form-group row" style="padding:10px;margin-vertical:auto;">
                        <div class="col-sm-2 col-xs-5 p-5 text-right">
                            <label>${counter}</label>
                            <button class="btn btn-default" onClick="howSpell('${word}');">Speak</button>
                        </div>
                        <div class="col-sm-10 col-xs-7 p-5 word-question form-inline">
                            <input class="form-control" style="margin-bottom:5px;" autocorrect="off" autocapitalize="none" type="search" autocomplete="off" data-word="${word}" />
                        </div>
                    </div>
                `;
                $("#word-test").append(newElement);
                counter +=1;
            });
        }

        function finishTest(){
            $(".test-inactive").show();
            $(".test-active").hide();
        }
        
        function check(){
            var incorrect = false;
            $(".word-question").each(function(){

                $(this).find('i').remove();
                var input = $(this).find('input');
                var val = input.val().toLowerCase();
                var parent = $(this).parent();
                var correct = input.attr('data-word').toLowerCase();
                
                if(val == correct) {
                    parent.addClass('bg-success').removeClass("bg-danger");
                    $(this).append(`<i class="fa fa-check-circle" style="font-size:25px;color:green;"></i>`);
                }
                else {
                    incorrect = true;
                    parent.addClass('bg-danger').removeClass("bg-success");
                    $(this).append(`<i class="fa fa-times-circle" style="font-size:25px;color:red;"></i>`);
                }
            });
            if(!incorrect) say("Yay! You got everything right!");
            else say("Good work. Keep practicing!");
        }

        function populateVoiceList() {
            voices = synth.getVoices().sort(function (a, b) {
                const aname = a.name.toUpperCase(), bname = b.name.toUpperCase();
                if ( aname < bname ) return -1;
                else if ( aname == bname ) return 0;
                else return +1;
            });
            var selectedIndex = voiceSelect.selectedIndex < 0 ? 0 : voiceSelect.selectedIndex;
            voiceSelect.innerHTML = '';
            for(i = 0; i < voices.length ; i++) {
                var option = document.createElement('option');
                option.textContent = voices[i].name + ' (' + voices[i].lang + ')';
                
                if(voices[i].default) {
                    option.textContent += ' -- DEFAULT';
                }

                option.setAttribute('data-lang', voices[i].lang);
                option.setAttribute('data-name', voices[i].name);
                voiceSelect.appendChild(option);
            }
            voiceSelect.selectedIndex = selectedIndex;
        }

        //populateVoiceList();
        // if (speechSynthesis.onvoiceschanged !== undefined) {
        //   speechSynthesis.onvoiceschanged = populateVoiceList;
        // }

        function howSpell(text){
            say("How do you spell: " + text);
        }
        
        function say(text){
            
            // if (synth.speaking) {
            //     console.error('speechSynthesis.speaking');
            //     return;
            // }
            if (text !== '') {
                var utterThis = new SpeechSynthesisUtterance(text);
                utterThis.onend = function (event) {
                    console.log('SpeechSynthesisUtterance.onend');
                }
                utterThis.onerror = function (event) {
                    console.error('SpeechSynthesisUtterance.onerror');
                }
                // var selectedOption = voiceSelect.selectedOptions[0].getAttribute('data-name');
                // for(i = 0; i < voices.length ; i++) {
                //   if(voices[i].name === selectedOption) {
                //     utterThis.voice = voices[i];
                //     break;
                //   }
                // }
                // utterThis.pitch = 1;
                // utterThis.rate = 1;
                synth.speak(utterThis);
            }
        }

    </script>
    </div>
    
  </body>
</html>